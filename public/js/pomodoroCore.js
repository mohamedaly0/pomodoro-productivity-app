// pomodoroCore.js (local)
class LocalPomodoroTimer {
  constructor(){this.modes={work:25*60,short_break:5*60,long_break:15*60};this.currentMode='work';this.timeLeft=this.modes.work;this.timer=null;this.isRunning=false;this.statsKey='pomo_stats_v1';this.stats={pomodoros:0,focusMinutes:0,tasksCompleted:0};this.loadStats();this.cacheEls();this.bind();this.updateUI();}
  cacheEls(){this.displayEl=document.getElementById('timerDisplay');this.labelEl=document.getElementById('timerLabel');this.progressEl=document.getElementById('progressFill');this.startBtn=document.getElementById('startTimerBtn');this.pauseBtn=document.getElementById('pauseTimerBtn');this.resetBtn=document.getElementById('resetTimerBtn');this.skipBtn=document.getElementById('skipTimerBtn');this.modeButtons=document.querySelectorAll('[data-session-type]');this.statPomodoros=document.getElementById('statPomodoros');this.statFocus=document.getElementById('statFocus');}
  bind(){this.startBtn?.addEventListener('click',()=>this.start());this.pauseBtn?.addEventListener('click',()=>this.pause());this.resetBtn?.addEventListener('click',()=>this.reset());this.skipBtn?.addEventListener('click',()=>this.completeSession(true));this.modeButtons.forEach(btn=>btn.addEventListener('click',()=>{if(this.isRunning)return;this.setMode(btn.dataset.sessionType);}));document.addEventListener('keydown',e=>{if(['INPUT','TEXTAREA'].includes(e.target.tagName))return;if(e.code==='Space'){e.preventDefault();this.isRunning?this.pause():this.start();}if(e.key.toLowerCase()==='r'){e.preventDefault();this.reset();}if(e.key.toLowerCase()==='s'){e.preventDefault();this.completeSession(true);}});}  
  setMode(mode){if(!this.modes[mode])return;this.currentMode=mode;this.timeLeft=this.modes[mode];document.body.className='mode-'+mode;this.updateUI();}
  start(){if(this.isRunning)return;this.isRunning=true;this.tick();this.timer=setInterval(()=>this.tick(),1000);this.refreshButtons();}
  pause(){if(!this.isRunning)return;this.isRunning=false;clearInterval(this.timer);this.refreshButtons();}
  reset(){this.pause();this.timeLeft=this.modes[this.currentMode];this.updateUI();}
  tick(){this.timeLeft-=1;if(this.timeLeft<=0){this.completeSession();return;}this.updateUI();}
  completeSession(skipped=false){this.pause();if(!skipped&&this.currentMode==='work'){this.stats.pomodoros+=1;this.stats.focusMinutes+=this.modes.work/60;window.localTasks?.incrementPomodoroForCurrent();this.saveStats();}if(this.currentMode==='work'){const cycle=this.stats.pomodoros%4===0?'long_break':'short_break';this.setMode(cycle);}else{this.setMode('work');}this.updateUI();}
  updateUI(){if(this.displayEl){const m=Math.floor(this.timeLeft/60).toString().padStart(2,'0');const s=(this.timeLeft%60).toString().padStart(2,'0');this.displayEl.textContent=`${m}:${s}`;document.title=`${m}:${s} â€¢ Pomodoro`;}if(this.labelEl){const map={work:'Focus Time',short_break:'Short Break',long_break:'Long Break'};this.labelEl.textContent=map[this.currentMode];}if(this.progressEl){const total=this.modes[this.currentMode];const pct=100*(1-(this.timeLeft/total));this.progressEl.style.width=pct+'%';}if(this.statPomodoros)this.statPomodoros.textContent=this.stats.pomodoros;if(this.statFocus)this.statFocus.textContent=`${Math.floor(this.stats.focusMinutes)}m`;this.refreshButtons();}
  refreshButtons(){if(this.startBtn)this.startBtn.disabled=this.isRunning;if(this.pauseBtn)this.pauseBtn.disabled=!this.isRunning;}
  loadStats(){try{const raw=localStorage.getItem(this.statsKey);if(raw)this.stats=JSON.parse(raw);}catch{}}
  saveStats(){localStorage.setItem(this.statsKey,JSON.stringify(this.stats));}
}
window.LocalPomodoroTimer=LocalPomodoroTimer;
